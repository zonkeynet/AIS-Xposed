<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>AIS Live – Warships & Logistics Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    :root { --bg:#0b1020; --panel:#121933; --accent:#56ccf2; --text:#e6eefc; --muted:#9db2d7; --danger:#ff6b6b; --warn:#f6c177; --ok:#7ad3a3; --chip:#1d2647; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{padding:14px 16px;background:linear-gradient(180deg,#0f1630,#0b1020);border-bottom:1px solid #1b254d;position:sticky;top:0;z-index:10}
    header h1{margin:0 0 8px;font-size:18px;font-weight:600}
    .toolbar{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center}
    .toolbar input[type=text]{padding:10px 12px;border-radius:10px;border:1px solid #22305f;background:#0f1530;color:var(--text);outline:none;width:100%}
    .toolbar label{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);background:var(--chip);padding:8px 10px;border-radius:999px;border:1px solid #22305f}
    .toolbar button{padding:10px 14px;border-radius:10px;border:1px solid #22305f;background:#16214a;color:var(--text);cursor:pointer;font-weight:600}
    .toolbar button:hover{background:#1a2757}
    main{display:grid;grid-template-columns:1fr 420px;gap:12px;padding:12px}
    #map{height:calc(100vh - 130px);border-radius:14px;overflow:hidden;border:1px solid #1b254d}
    aside{display:grid;gap:12px;height:calc(100vh - 130px);grid-template-rows:auto auto 1fr}
    .card{background:var(--panel);border:1px solid #1b254d;border-radius:14px;padding:12px}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .stat{background:#0f1530;border:1px solid #22305f;border-radius:12px;padding:10px;text-align:center}
    .stat .label{font-size:12px;color:var(--muted)} .stat .value{margin-top:6px;font-size:16px;font-weight:700}
    .state-dot{width:8px;height:8px;display:inline-block;border-radius:50%;margin-right:6px}
    .online{background:var(--ok)} .offline{background:var(--danger)} .warn{background:var(--warn)}
    .log{height:150px;overflow:auto;background:#0f1530;border:1px solid #22305f;border-radius:12px;padding:8px 10px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    table{width:100%;border-collapse:collapse;font-size:13px} th,td{padding:8px 6px;border-bottom:1px solid #1b254d;color:#d8e3fb}
    th{position:sticky;top:0;background:#16214a;z-index:1}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;margin:2px;background:#0f1530;border:1px solid #22305f;color:#dbe7ff}
    .chip.mil{background:#1f2d59;border-color:#314684}.chip.isr{background:#1d3a46;border-color:#2f5e70}.chip.arm{background:#4a2231;border-color:#6f3350}
    .chip.san{background:#4a2f1d;border-color:#81542f}.chip.un{background:#243d2d;border-color:#3b6a4c}
    .hint{color:var(--muted);font-size:12px}
    @media (max-width:1100px){main{grid-template-columns:1fr}aside{height:auto}#map{height:50vh}}
  </style>
</head>
<body>
  <header>
    <h1>AIS Live – Warships & Logistics Tracker</h1>
    <div class="toolbar">
      <input id="ws-url" type="text" placeholder="wss://ais-proxy.tuo-dominio.workers.dev/api/vessels" />
      <label title="Ricevi ShipStaticData (solo log)">
        <input id="static-toggle" type="checkbox" /> static=1
      </label>
      <button id="connect-btn">Connetti</button>
      <button id="disconnect-btn">Disconnetti</button>
    </div>
    <div class="hint" style="margin-top:8px">
      Puoi passare il WS via query: <code>?ws=wss://…/api/vessels&amp;static=1</code>
    </div>
  </header>

  <main>
    <div id="map" aria-label="Mappa navi AIS"></div>
    <aside>
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div><span id="state-dot" class="state-dot offline"></span><b id="state-label">offline</b></div>
          <div class="hint">Stato connessione al Worker</div>
        </div>
        <div class="stats">
          <div class="stat"><div class="label">Messaggi</div><div id="stat-messages" class="value">0</div></div>
          <div class="stat"><div class="label">Navi viste</div><div id="stat-vessels" class="value">0</div></div>
          <div class="stat"><div class="label">Ultimo update</div><div id="stat-last" class="value">—</div></div>
          <div class="stat"><div class="label">Errori</div><div id="stat-errors" class="value">0</div></div>
        </div>
      </div>
      <div class="card">
        <div style="font-weight:600;margin-bottom:6px">Eventi/Diagnostica</div>
        <div id="log" class="log" aria-live="polite"></div>
      </div>
      <div class="card" style="overflow:auto">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <input id="filter" type="text" placeholder="Filtra per nome/MMSI/tag…" style="flex:1;padding:8px 10px;border-radius:10px;border:1px solid #22305f;background:#0f1530;color:#dfe9ff" />
          <span class="hint">clic su riga/marker per centrare</span>
        </div>
        <table id="grid" aria-label="Elenco navi">
          <thead>
            <tr>
              <th style="width:36px">#</th>
              <th>Nome</th>
              <th>MMSI</th>
              <th>Lat</th>
              <th>Lon</th>
              <th>SOG</th>
              <th>COG</th>
              <th>Tags</th>
            </tr>
          </thead>
          <tbody id="grid-body"></tbody>
        </table>
      </div>
    </aside>
  </main>

  <script>
    const DEFAULT_WS = "wss://ais-proxy.zonkeynet.workers.dev/api/vessels";
    const qs = new URLSearchParams(location.search);
    const wsInput = document.getElementById('ws-url');
    const staticChk = document.getElementById('static-toggle');
    wsInput.value = qs.get('ws') || DEFAULT_WS;
    staticChk.checked = qs.get('static') === '1';

    let map, markers = new Map();
    function initMap(){
      map = L.map('map', { preferCanvas:true }).setView([32,20], 3);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 10, attribution: '&copy; OpenStreetMap' }).addTo(map);
    }
    function colorFor(v){
      if (v.military && v.arms) return '#ff6b6b';
      if (v.is_israel_related) return '#56ccf2';
      if ((v.tags||[]).includes('sanctioned_ofac') || (v.tags||[]).includes('sanctioned_sdgt')) return '#ffa94d';
      if ((v.tags||[]).includes('documented_by_UN')) return '#7ad3a3';
      return '#b9c2e6';
    }
    function upsertMarker(v){
      const key = v.mmsi || v.id; if (!key) return;
      const opts = { radius:6, stroke:true, weight:2, opacity:1, fillOpacity:0.8, color:'#0b1020', fillColor:colorFor(v) };
      let m = markers.get(key);
      if (!m){ m = L.circleMarker([v.lat, v.lon], opts).addTo(map); m.on('click',()=>centerOn(v.mmsi)); markers.set(key,m); }
      else { m.setLatLng([v.lat, v.lon]); m.setStyle(opts); }
      const badges = [
        v.military ? '<span class="chip mil">military</span>' : '',
        v.arms ? '<span class="chip arm">arms</span>' : '',
        v.is_israel_related ? '<span class="chip isr">israel_related</span>' : ''
      ].filter(Boolean).join(' ');
      m.bindPopup(`<b>${esc(v.name||'')}</b><div class="hint">${v.mmsi}</div><div style="margin-top:6px">${badges||'<span class="chip">tracked</span>'}</div>
      <hr style="border-color:#22305f" />
      <div>Lat ${fmt(v.lat)} | Lon ${fmt(v.lon)}</div><div>SOG ${fmt(v.sog)} kn | COG ${fmt(v.cog)}°</div>`);
    }
    function centerOn(mmsi){
      const m = markers.get(mmsi); if (m) { map.flyTo(m.getLatLng(), Math.max(map.getZoom(), 6), { duration: 0.6 }); m.openPopup(); }
    }
    function esc(s){return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
    function fmt(n){return (typeof n==='number'&&isFinite(n))? n.toFixed(4) : '—'}

    // UI state
    const stateDot = document.getElementById('state-dot');
    const stateLabel = document.getElementById('state-label');
    const statMsg = document.getElementById('stat-messages');
    const statVessels = document.getElementById('stat-vessels');
    const statLast = document.getElementById('stat-last');
    const statErrors = document.getElementById('stat-errors');
    const logEl = document.getElementById('log');
    const filterEl = document.getElementById('filter');
    const gridBody = document.getElementById('grid-body');

    let ws=null, connected=false, messages=0, errors=0, reconnectDelay=1500, reconnectTimer=null;
    const vessels = new Map();

    function setState(ok,warn=false){ stateDot.className='state-dot '+(ok?(warn?'warn':'online'):'offline'); stateLabel.textContent=ok?(warn?'online (warning)':'online'):'offline'; }
    function logLine(o){ const ts=new Date().toLocaleTimeString(); logEl.textContent += `[${ts}] ${typeof o==='string'?o:JSON.stringify(o)}\n`; logEl.scrollTop=logEl.scrollHeight; }
    function updateStats(){ statMsg.textContent=String(messages); statVessels.textContent=String(vessels.size); statLast.textContent=new Date().toLocaleTimeString(); statErrors.textContent=String(errors); }

    function renderTable(){
      const q=(filterEl.value||'').toLowerCase(); const rows=[]; let i=0;
      for (const v of vessels.values()){
        const txt=`${v.name} ${v.mmsi} ${(v.tags||[]).join(' ')}`.toLowerCase();
        if (q && !txt.includes(q)) continue;
        const tags=[];
        if (v.military) tags.push('<span class="chip mil">military</span>');
        if (v.arms) tags.push('<span class="chip arm">arms</span>');
        if (v.is_israel_related) tags.push('<span class="chip isr">israel_related</span>');
        rows.push(`<tr data-mmsi="${v.mmsi}"><td>${++i}</td><td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(v.name)}">${esc(v.name)}</td><td>${v.mmsi}</td><td>${fmt(v.lat)}</td><td>${fmt(v.lon)}</td><td>${fmt(v.sog)}</td><td>${fmt(v.cog)}</td><td>${tags.join(' ')||'<span class="chip">tracked</span>'}</td></tr>`);
      }
      gridBody.innerHTML = rows.join('');
      for (const tr of gridBody.querySelectorAll('tr')) tr.addEventListener('click',()=>centerOn(tr.getAttribute('data-mmsi')));
    }

    function connect(){
      let url = wsInput.value.trim(); if (!url) return;
      if (staticChk.checked && !url.includes('static=1')) url += (url.includes('?')?'&':'?')+'static=1';
      try { ws = new WebSocket(url); } catch(e){ errors++; updateStats(); logLine({error:'ws_open_failed', detail:String(e)}); scheduleReconnect(); return; }

      ws.onopen = () => { connected=true; setState(true); reconnectDelay=1500; logLine({info:'socket_open'}); };
      ws.onmessage = ev => {
        messages++; updateStats();
        try{
          const m = JSON.parse(ev.data);
          if (m.ka) return;
          if (m.info) { logLine(m); return; }
          if (m.error){ errors++; updateStats(); logLine(m); return; }
          if (typeof m.lat!=='number' || typeof m.lon!=='number') return;
          vessels.set(m.mmsi, m);
          upsertMarker(m);
          renderTable();
        }catch(e){ errors++; updateStats(); logLine({error:'parse_error', detail:String(e)}); }
      };
      ws.onerror = () => { errors++; updateStats(); setState(true,true); logLine('socket_error'); };
      ws.onclose = () => { connected=false; setState(false); logLine('socket_closed'); scheduleReconnect(); };
    }
    function disconnect(){
      if (ws) try{ ws.close(1000,'manual_close'); }catch{}
      ws=null; connected=false; setState(false);
      if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer=null; }
    }
    function scheduleReconnect(){
      if (reconnectTimer) return;
      reconnectDelay = Math.min(Math.floor(reconnectDelay*1.7), 15000);
      reconnectTimer = setTimeout(()=>{ reconnectTimer=null; if (!connected) connect(); }, reconnectDelay);
    }

    document.getElementById('connect-btn').addEventListener('click', ()=>{ disconnect(); connect(); });
    document.getElementById('disconnect-btn').addEventListener('click', ()=>{ disconnect(); });
    document.getElementById('filter').addEventListener('input', renderTable);

    window.addEventListener('load', ()=>{ initMap(); connect(); });
    staticChk.addEventListener('change', ()=>{ if (connected){ disconnect(); connect(); } });
  </script>
</body>
</html>
