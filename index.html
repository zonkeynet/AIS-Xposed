<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>AIS Xposed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap');
    body{font-family:'Roboto Mono',monospace;color:#e5e7eb}
    #map{height:100vh;width:100%}
    .vessel-card{cursor:pointer;transition:all .2s;background:#111827;border:1px solid #374151}
    .vessel-card:hover{transform:translateY(-2px);box-shadow:0 0 15px rgba(79,70,229,.5);border-color:#4f46e5}
    .leaflet-popup-content-wrapper{border-radius:8px;background:#1f2937;color:#e5e7eb}
    .leaflet-popup-content{margin:14px;font-size:14px}
    .tag-badge{display:inline-block;margin:2px 6px 0 0;padding:2px 8px;border-radius:9999px;font-size:11px;border:1px solid rgba(255,255,255,.2);background:rgba(31,41,55,.9);color:#e5e7eb;white-space:nowrap}
    .tag--mil{border-color:#ef4444;color:#fca5a5}
    .tag--isr{border-color:#818cf8;color:#a5b4fc}
    .tag--arms{border-color:#f59e0b;color:#fdba74}
    .tag--un{border-color:#60a5fa;color:#93c5fd}
    .tag--invest{border-color:#f59e0b;color:#fbbf24}
    .tag--deny{border-color:#f87171;color:#fca5a5}
  </style>
</head>
<body class="bg-gray-900 flex h-screen overflow-hidden text-gray-200">

<button id="openSidebarButton" class="md:hidden fixed top-4 left-4 z-40 p-3 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/></svg>
</button>
<div id="sidebarOverlay" class="fixed inset-0 bg-black opacity-0 md:opacity-0 pointer-events-none transition-opacity duration-300 z-20"></div>

<aside id="sidebar" class="w-full md:w-96 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 flex-shrink-0 bg-gray-800 shadow-2xl p-4 flex flex-col z-30 border-r border-gray-700">
  <header class="pb-2 border-b border-gray-700 flex justify-between items-start">
    <div>
      <h1 class="text-2xl font-bold text-indigo-400">AIS Xposed <span class="text-sm text-red-500">LIVE</span></h1>
      <p id="connectionStatus" class="text-sm font-medium mt-2 p-2 rounded-lg text-yellow-300 bg-yellow-900 border border-yellow-500">
        Connessione al server in corso...
      </p>
    </div>
    <button id="closeSidebarButton" class="md:hidden p-1 text-gray-400 hover:text-gray-200">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
    </button>
  </header>

  <div class="mt-4 p-4 bg-gray-900 rounded-xl border border-gray-700">
    <h2 class="text-lg font-semibold text-gray-200 mb-3">Filtri</h2>
    <div class="space-y-3 text-sm">
      <label class="flex items-center text-indigo-400">
        <input type="checkbox" id="filterIsrael" onchange="applyFilters()" class="h-5 w-5" checked>
        <span class="ml-3">Affiliate a Israele</span>
      </label>
      <label class="flex items-center text-red-400">
        <input type="checkbox" id="filterMilitary" onchange="applyFilters()" class="h-5 w-5" checked>
        <span class="ml-3">Militari / Logistica</span>
      </label>
      <label class="flex items-center text-amber-400">
        <input type="checkbox" id="filterArms" onchange="applyFilters()" class="h-5 w-5" checked>
        <span class="ml-3">Trasporto Armi</span>
      </label>
    </div>
    <div class="mt-5">
      <label for="destinationPort" class="block text-sm font-medium text-gray-400 mb-1">Destinazione contiene:</label>
      <input type="text" id="destinationPort" oninput="applyFilters()" placeholder="ES: LIVORNO, HAIFA..." class="w-full p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-lg text-sm">
    </div>
  </div>

  <div class="mt-4 flex-grow overflow-y-auto">
    <h2 class="text-xl font-bold text-gray-200 mb-3">Vessel Registry (<span id="vesselCount" class="text-indigo-400">0</span>)</h2>
    <div id="vesselList" class="space-y-3 pr-2">
      <p id="vesselListPlaceholder" class="text-center text-gray-500 py-6 text-sm">Waiting for incoming AIS data stream...</p>
    </div>
  </div>
</aside>

<main id="map" class="flex-grow"></main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // Sostituisci YOURNAME con il tuo account Workers
  const WORKER_URL = 'wss://ais-xposed.zonkeynet.workers.dev/api/vessels?debug=1';

  const map = L.map('map').setView([38.0, 15.0], 5);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png', {
    attribution:'&copy; OpenStreetMap & CARTO', subdomains:'abcd', maxZoom:20
  }).addTo(map);

  const vesselDataMap = new Map();
  const markerLayer = new L.LayerGroup().addTo(map);
  let ws;

  const COLOR = { military:'#f87171', arms:'#fbbf24', israel:'#6366f1', def:'#22c55e' };

  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  document.getElementById('openSidebarButton').onclick = ()=>toggleSidebar(true);
  document.getElementById('closeSidebarButton').onclick = ()=>toggleSidebar(false);
  overlay.onclick = ()=>toggleSidebar(false);
  function toggleSidebar(open){
    if (window.innerWidth>=768) return;
    if (open){ sidebar.classList.remove('-translate-x-full'); overlay.classList.add('opacity-50','pointer-events-auto'); }
    else { sidebar.classList.add('-translate-x-full'); overlay.classList.remove('opacity-50','pointer-events-auto'); }
  }

  function tagClass(tag){
    const t=(tag||'').toLowerCase();
    if (t.includes('mil')) return 'tag-badge tag--mil';
    if (t.includes('israel')) return 'tag-badge tag--isr';
    if (t.includes('arms')||t.includes('ammo')) return 'tag-badge tag--arms';
    if (t.includes('ohchr')||t.includes('un')) return 'tag-badge tag--un';
    if (t.includes('invest')) return 'tag-badge tag--invest';
    if (t.includes('denial')) return 'tag-badge tag--deny';
    return 'tag-badge';
  }

  function iconFor(v){
    let c = COLOR.def;
    if (v.military) c = COLOR.military;
    else if (v.arms) c = COLOR.arms;
    else if (v.is_israel_related) c = COLOR.israel;
    const svg = `<svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(${v.cog||0}deg);">
      <path d="M14 2L7 26H21L14 2Z" fill="${c}" stroke="white" stroke-width="1.5" stroke-linejoin="round"/></svg>`;
    return L.divIcon({ className:'custom-marker', html:svg, iconSize:[28,28], iconAnchor:[14,14], popupAnchor:[0,-14] });
  }

  function popupHTML(v){
    const cats = [
      v.military && '<span class="font-bold text-red-400">::MILITARY::</span>',
      v.arms && '<span class="font-bold text-amber-400">::ARMS_TRANSPORT::</span>',
      v.is_israel_related && '<span class="font-bold text-indigo-400">::ISRAEL_AFFILIATE::</span>'
    ].filter(Boolean).join('<br>');
    const tags = (Array.isArray(v.tags)? v.tags : []).map(t=>`<span class="${tagClass(t)}">${t}</span>`).join('');
    return `
      <strong class="text-lg text-white">${v.name}</strong><br>
      <hr class="my-1 border-gray-600">
      <span class="text-gray-400">MMSI:</span> ${v.mmsi}<br>
      <span class="text-gray-400">Destinazione:</span> ${v.destination || 'N/A'}<br>
      <span class="text-gray-400">Stato:</span> ${v.status || 'N/A'}<br>
      <span class="text-gray-400">Velocità:</span> ${v.sog ? v.sog+' kn' : 'N/A'}<br>
      ${cats? cats+'<br>':''}
      ${tags? `<div class="mt-2 text-xs"><span class="font-bold text-gray-400">Fonti/Tags:</span><div class="mt-1">${tags}</div></div>`:''}
    `;
  }

  function renderMarkers(list){
    const onMap = new Set();
    list.forEach(v=>{
      onMap.add(v.mmsi);
      const ic = iconFor(v);
      if (v.marker){
        v.marker.setLatLng([v.lat, v.lon]).setIcon(ic);
      } else {
        v.marker = L.marker([v.lat, v.lon], {icon: ic}).addTo(markerLayer);
        v.marker.bindPopup(()=>popupHTML(v));
      }
    });
    // cleanup
    [...vesselDataMap.values()].forEach(v=>{
      if (v.marker && !onMap.has(v.mmsi)){ markerLayer.removeLayer(v.marker); v.marker=null; }
    });
  }

  function renderList(list){
    const box = document.getElementById('vesselList');
    const cnt = document.getElementById('vesselCount');
    const ph = document.getElementById('vesselListPlaceholder');
    box.innerHTML=''; cnt.textContent=list.length; ph.style.display = list.length? 'none':'block';

    list.forEach(v=>{
      const div = document.createElement('div');
      div.className="vessel-card p-3 rounded-lg border";
      const badge = v.military? 'MIL' : v.arms? 'ARMS' : v.is_israel_related? 'ISR' : 'STD';
      div.innerHTML = `
        <div class="flex justify-between items-center">
          <p class="text-base font-semibold text-gray-50 truncate">${v.name}</p>
          <span class="text-xs font-bold px-2 py-1 rounded-full border ${v.military?'bg-red-900 text-red-300 border-red-500':v.arms?'bg-amber-900 text-amber-300 border-amber-500':v.is_israel_related?'bg-indigo-900 text-indigo-300 border-indigo-500':'bg-green-900 text-green-300 border-green-500'}">${badge}</span>
        </div>
        <p class="text-sm text-gray-400 truncate">MMSI: ${v.mmsi}</p>
        <p class="text-sm text-gray-400 truncate">Dest: ${v.destination || 'N/A'}</p>
      `;
      div.onclick = ()=>{
        if (v.marker && v.lat && v.lon){ map.setView([v.lat, v.lon], 10); v.marker.openPopup(); toggleSidebar(false); }
      };
      box.appendChild(div);
    });
  }

  function handleMessage(msg){
    if (msg.info){ setStatus('INFO: '+msg.info, 'ok'); return; }
    if (msg.error){ setStatus(`ERROR: ${msg.error}${msg.detail? ' — '+msg.detail:''}`, 'error'); return; }
    if (msg.static_only){ setStatus('DEBUG: ShipStaticData ricevuto – flusso OK (no posizione)', 'ok'); return; }
    if (msg.lat==null || msg.lon==null) return;

    const prev = vesselDataMap.get(msg.id);
    vesselDataMap.set(msg.id, {...prev, ...msg, marker: prev?.marker});
    applyFilters();
  }

  function applyFilters(){
    const f = {
      mil:  document.getElementById('filterMilitary').checked,
      arms: document.getElementById('filterArms').checked,
      isr:  document.getElementById('filterIsrael').checked,
      dst:  (document.getElementById('destinationPort').value||'').toLowerCase().trim()
    };
    const allOff = !f.mil && !f.arms && !f.isr;
    const arr = Array.from(vesselDataMap.values());
    const out = arr.filter(v=>{
      if (v.lat==null || v.lon==null) return false;
      const cat = allOff || (f.mil && v.military) || (f.arms && v.arms) || (f.isr && v.is_israel_related);
      const dst = !f.dst || ((v.destination||'').toLowerCase().includes(f.dst));
      return cat && dst;
    }).sort((a,b)=>(a.name||'').localeCompare(b.name||''));
    renderMarkers(out);
    renderList(out);
  }

  function setStatus(t, type){
    const el = document.getElementById('connectionStatus');
    el.textContent = t;
    el.className = 'text-sm font-medium mt-2 p-2 rounded-lg border ';
    if (type==='ok') el.classList.add('text-green-300','bg-green-900','border-green-500');
    else if (type==='error') el.classList.add('text-red-300','bg-red-900','border-red-500');
    else el.classList.add('text-yellow-300','bg-yellow-900','border-yellow-500');
  }

  // Connessione WS con retry esponenziale lato client (comunque il Worker ora NON chiude)
  let retry = 2000;
  function connect(){
    try{
      if (ws && (ws.readyState===WebSocket.OPEN || ws.readyState===WebSocket.CONNECTING)) return;
      ws = new WebSocket(WORKER_URL);
      ws.onopen = ()=>{ setStatus('STREAM ONLINE / DATA FLOW ACTIVE','ok'); retry=2000; };
      ws.onmessage = (ev)=>{ try{ handleMessage(JSON.parse(ev.data)); }catch(e){ console.error(e); } };
      ws.onclose = ()=>{ setStatus('BROWSER WS CHIUSO: RICONNESSIONE...', 'error'); setTimeout(connect, Math.min(retry,15000)); retry*=2; };
      ws.onerror = ()=>{ setStatus('ERRORE WS BROWSER: RETRY...', 'error'); try{ ws.close(); }catch{} };
    }catch(e){
      setStatus('WS INIT ERROR — '+String(e),'error');
      setTimeout(connect, Math.min(retry,15000)); retry*=2;
    }
  }
  connect();
</script>
</body>
</html>
