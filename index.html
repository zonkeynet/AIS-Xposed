<!doctype html>
<meta charset="utf-8"/>
<title>AIS Live</title>
<style>
  body { font-family: system-ui, sans-serif; padding: 16px; }
  #log { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
</style>
<h1>AIS Live</h1>
<div>State: <span id="state">connecting…</span></div>
<div>Messages: <span id="count">0</span></div>
<pre id="log"></pre>
<script>
const WS_URL = "wss://ais-proxy.zonkeynet.workers.dev/api/vessels?debug=0"; // ← cambia qui

let count = 0;
const elState = document.getElementById('state');
const elCount = document.getElementById('count');
const elLog   = document.getElementById('log');

function log(o){ elLog.textContent += (typeof o === 'string' ? o : JSON.stringify(o)) + "\n"; }

function connect(){
  elState.textContent = 'connecting…';
  const ws = new WebSocket(WS_URL);

  ws.addEventListener('open', () => { elState.textContent = 'online'; });

  ws.addEventListener('message', (ev) => {
    try {
      const msg = JSON.parse(ev.data);
      if (msg.ka) return; // keepalive
      if (msg.info || msg.error) { log(msg); return; }

      // messaggi nave
      count++; elCount.textContent = String(count);
      // mostra le prime 3 navi e poi smette di loggare per non saturare
      if (count <= 3) log(msg);

    } catch (e) {
      log({ parse_error: String(e), raw: ev.data.slice(0,200) });
    }
  });

  ws.addEventListener('close', () => {
    elState.textContent = 'closed – retrying in 2s';
    setTimeout(connect, 2000);
  });

  ws.addEventListener('error', () => {
    elState.textContent = 'error – retrying in 2s';
    try { ws.close(); } catch {}
  });
}

connect();
</script>
